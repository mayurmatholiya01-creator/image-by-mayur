<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tile Search</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:#0f1f1f; color:#fff; padding:20px; min-height:100vh;
    }
    .container { max-width:900px; margin:0 auto }
    .main-card {
      background:linear-gradient(135deg,#1a3333,#0d2626);
      border-radius:16px; padding:32px; border:1px solid #2d4a4a;
      box-shadow:0 20px 60px rgba(0,0,0,0.4); position:relative;
    }
    .main-card::before {
      content:''; position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,#10b981,#059669,#047857);
    }
    .filter-section,.search-section { margin-bottom:24px }
    .filter-label {
      color:#d1d5db;font-size:14px;font-weight:600;
      text-transform:uppercase;letter-spacing:0.5px;
      margin-bottom:8px;display:block;
    }
    .filter-dropdown,.search-input {
      width:100%;padding:16px 20px;background:#1a3333;
      border:1px solid #2d4a4a;border-radius:12px;color:#fff;
      font-size:16px;outline:none;transition:0.3s;
    }
    .filter-dropdown { 
      appearance:none;padding-right:50px;
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-repeat:no-repeat;background-position:right 16px center;background-size:16px;
    }
    .filter-dropdown:focus,.search-input:focus {
      border-color:#10b981;box-shadow:0 0 0 3px rgba(16,185,129,0.1);
    }
    .results-container {
      background:#1a3333;border:1px solid #2d4a4a;
      border-radius:12px;padding:24px;color:#6b7280;
    }
    .tile {
      display:flex;align-items:center;
      background:#152a2a;border:1px solid #2d4a4a;
      border-radius:12px;margin-bottom:16px;overflow:hidden;
    }
    .tile-image {
      width:100px;height:100px;background:#0d1f1f;
      display:flex;align-items:center;justify-content:center;
      border-right:1px solid #2d4a4a;color:#6b7280;
      font-size:12px;text-align:center;
    }
    .tile-image img {
      width:100%;height:100%;object-fit:cover;
    }
    .tile-info { flex:1;padding:16px }
    .tile-info strong { color:#fff;display:block;margin-bottom:4px }
    .tile-info small { color:#9ca3af }
    .tile-buttons { 
      display:flex;gap:8px;padding:16px;flex-direction:column;
    }
    .tile-buttons button {
      border:none;color:#fff;padding:10px 16px;border-radius:8px;
      cursor:pointer;font-size:14px;font-weight:500;
      transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .download-btn { background:#10b981 }
    .download-btn:hover { background:#059669 }
    .whatsapp-btn { background:#25D366 }
    .whatsapp-btn:hover { background:#128C7E }
    .whatsapp-icon {
      width:16px;height:16px;fill:currentColor;
    }
    
    /* Hidden file input */
    .hidden-file-input {
      position:absolute;top:-9999px;opacity:0;pointer-events:none;
    }
    
    @media(max-width:640px){
      .tile { flex-direction:column;text-align:center }
      .tile-image { width:100%;height:200px;border:none }
      .tile-buttons { flex-direction:row;justify-content:center }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main-card">
      <div class="filter-section">
        <label class="filter-label">Filter by Size</label>
        <select id="sizeFilter" class="filter-dropdown">
          <option value="">All Sizes</option>
        </select>
      </div>
      <div class="search-section">
        <input id="searchInput" class="search-input" type="text"
               placeholder="Search tiles by design name..." />
      </div>
      <div id="resultsContainer" class="results-container">
        <div style="text-align:center;padding:40px;color:#6b7280;">
          Type to search tiles...
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for WhatsApp sharing -->
  <input type="file" id="hiddenFileInput" class="hidden-file-input" accept="image/*">

  <script>
    const sizeFilter = document.getElementById('sizeFilter');
    const searchInput = document.getElementById('searchInput');
    const resultsContainer = document.getElementById('resultsContainer');
    const hiddenFileInput = document.getElementById('hiddenFileInput');
    let tilesData = [];
    let isInitialLoad = true;

    function getImageUrl(driveUrl) {
      if (!driveUrl || !driveUrl.includes('drive.google.com')) return '';
      const fileId = driveUrl.match(/[-\w]{25,}/);
      return fileId ? `https://drive.google.com/thumbnail?id=${fileId[0]}&sz=w200` : '';
    }

    function getDownloadUrl(driveUrl) {
      if (!driveUrl || !driveUrl.includes('drive.google.com')) return driveUrl;
      const fileId = driveUrl.match(/[-\w]{25,}/);
      return fileId ? `https://drive.google.com/uc?export=download&id=${fileId[0]}` : driveUrl;
    }

    function getDirectImageUrl(driveUrl) {
      if (!driveUrl || !driveUrl.includes('drive.google.com')) return driveUrl;
      const fileId = driveUrl.match(/[-\w]{25,}/);
      return fileId ? `https://lh3.googleusercontent.com/d/${fileId[0]}=w1000` : driveUrl;
    }

    function populateSizeFilter() {
      const sizes = [...new Set(tilesData.map(t => t.dimensions))].sort();
      sizeFilter.innerHTML = '<option value="">All Sizes</option>';
      sizes.forEach(size => {
        const opt = document.createElement('option');
        opt.value = size;
        opt.textContent = size;
        sizeFilter.appendChild(opt);
      });
    }

    function displayTiles(tiles) {
      if (isInitialLoad && !searchInput.value.trim() && !sizeFilter.value) {
        tiles = tiles.slice(0, 5);
      }

      if (!tiles.length) {
        resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">No tiles found</div>';
        return;
      }

      const whatsappIcon = `<svg class="whatsapp-icon" viewBox="0 0 24 24">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
      </svg>`;

      resultsContainer.innerHTML = tiles.map(tile => {
        const imageUrl = getImageUrl(tile.url);
        const downloadUrl = getDownloadUrl(tile.url);
        const directImageUrl = getDirectImageUrl(tile.url);
        
        return `
          <div class="tile">
            <div class="tile-image">
              ${imageUrl ? `<img src="${imageUrl}" alt="${tile.design_name}" loading="lazy" />` : 'No Image'}
            </div>
            <div class="tile-info">
              <strong>${tile.design_name}</strong>
              <small>${tile.dimensions}</small>
            </div>
            <div class="tile-buttons">
              <button class="download-btn" onclick="window.open('${downloadUrl}', '_blank')">
                Download
              </button>
              <button class="whatsapp-btn" onclick="shareToWhatsAppDirect('${tile.design_name}', '${directImageUrl}')">
                ${whatsappIcon} WhatsApp
              </button>
            </div>
          </div>
        `;
      }).join('');

      isInitialLoad = false;
    }

    async function shareToWhatsAppDirect(tileName, imageUrl) {
      try {
        // Mobile detection
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // Mobile के लिए direct WhatsApp app approach
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          
          // Create a data URL from the blob
          const reader = new FileReader();
          reader.onload = function() {
            const dataUrl = reader.result;
            
            // For mobile - direct WhatsApp intent with base64 image
            const whatsappUrl = `whatsapp://send?text=${encodeURIComponent(`data:image/jpeg;base64,${dataUrl.split(',')[1]}`)}`;
            
            // Try different WhatsApp approaches
            const link = document.createElement('a');
            link.href = whatsappUrl;
            link.click();
            
            // Fallback - try to open WhatsApp web after delay
            setTimeout(() => {
              window.open('whatsapp://send', '_blank');
            }, 1000);
            
            // Second fallback - WhatsApp web
            setTimeout(() => {
              window.open('https://wa.me/?text=' + encodeURIComponent(imageUrl), '_blank');
            }, 2000);
          };
          reader.readAsDataURL(blob);
          
        } else {
          // Desktop approach - download and manual share
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          
          // Download the image
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${tileName}.jpg`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Open WhatsApp web
          setTimeout(() => {
            window.open('https://web.whatsapp.com/', '_blank');
          }, 500);
          
          // Show instruction
          alert('Image downloaded! Now you can attach it in WhatsApp.');
        }
        
      } catch (error) {
        console.error('Error:', error);
        // Ultimate fallback - just open the image
        window.open(imageUrl, '_blank');
      }
    }

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedSize = sizeFilter.value;
      
      let filtered = tilesData;
      
      if (searchTerm) {
        filtered = filtered.filter(tile => 
          tile.design_name.toLowerCase().includes(searchTerm)
        );
        isInitialLoad = false;
      }
      
      if (selectedSize) {
        filtered = filtered.filter(tile => tile.dimensions === selectedSize);
        isInitialLoad = false;
      }
      
      displayTiles(filtered);
    }

    searchInput.addEventListener('input', applyFilters);
    sizeFilter.addEventListener('change', applyFilters);

    async function loadData() {
      try {
        const csvUrl = 'https://docs.google.com/spreadsheets/d/1oHpJw-_zLdf_jt2SL5l7Hpiu8nSK9gvXfLEVvLlz5cM/export?format=csv&gid=622851011';
        const response = await fetch(csvUrl);
        const csvText = await response.text();
        
        const lines = csvText.trim().split('\n');
        const [header, ...rows] = lines;
        
        tilesData = [];
        rows.forEach((line, index) => {
          if (line.trim()) {
            const columns = line.split(',');
            if (columns.length >= 5) {
              tilesData.push({
                filename: columns[0] || '',
                dimensions: columns[1] || '',
                design_name: columns[2] || `Design ${index + 1}`,
                url: columns[3] || '',
                uploaded_at: columns[4] || ''
              });
            }
          }
        });

        populateSizeFilter();
        applyFilters();
        
      } catch (error) {
        console.error('Error loading data:', error);
        resultsContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#ef4444;">Failed to load tiles. Please try again.</div>';
      }
    }

    loadData();
  </script>
</body>
</html>
